# Release Notes - vS0006

## 版本信息
- **版本號**: vS0006
- **發布日期**: 2026-01-09

---

## 🎯 主要更新

### ✨ 功能改進

#### 1. 智能價格獲取策略（庫存市價數據源優化）

**新增功能**：
- ✅ 根據交易時間自動切換數據來源
  - **盤中（09:00-13:30）**：使用即時價格（TWSE MIS API）
  - **盤後（13:30 後）**：自動切換到收盤價（TWSE OpenAPI）
  - **非交易日**：使用最近交易日收盤價
- ✅ 即時 API 失敗時自動降級到收盤價
- ✅ 整合 `priceSource` 設定，支援手動選擇數據來源
  - `auto`：自動模式（根據交易時間智能切換）
  - `realtime`：強制使用即時數據
  - `twse_stock_day_all`：強制使用收盤價

**改進內容**：
- ✅ 動態緩存策略優化
  - 盤中：緩存 1 分鐘（即時數據變化快）
  - 盤後：緩存 1 小時（收盤價相對穩定）
  - 非交易日：緩存 24 小時（避免不必要的請求）
- ✅ 價格來源資訊顯示
  - 庫存頁面顯示價格來源標籤（⚡即時 / 📊收盤）
  - 顯示價格最後更新時間（時:分）

**技術細節**：
- 新增 `isTradingHours()` 和 `isTradingDay()` 函數判斷交易時間
- 新增 `getCacheDuration()` 動態緩存時間函數
- 優化 `fetchStockPricesBatch()` 支援智能切換和降級
- 返回數據包含 `price_source` 和 `price_updated_at` 欄位

#### 2. 使用指南頁面改進

**新增功能**：
- ✅ 第7步驟：讚賞碼區域
  - 顯示三個讚賞碼 QR Code 圖片（微信、富邦、全支付）
  - 圖片尺寸為原始尺寸的一半（更易掃描）
  - 圖片排列在聯絡資訊下方

**改進內容**：
- ✅ 使用指南只顯示一次
  - 初次登入時自動跳轉到使用指南頁面
  - 已看過後不會再自動顯示
  - 仍可手動點擊側邊欄「使用指南」查看

**圖片資訊**：
- 微信讚賞碼：qrcode.png（1152x1152 → 576x576 顯示）
- 富邦讚賞碼：qrcode1.png（660x660 → 330x330 顯示）
- 全支付讚賞碼：qrcode2.png（951x1132 → 475x566 顯示）

#### 3. 登入頁面默認管理員帳號提示

**新增功能**：
- ✅ 默認管理員帳號提示只顯示一次
  - 首次登入時顯示提示框
  - 可手動點擊 ✕ 關閉，之後不再顯示
  - 在後台管理中修改帳號或密碼後，自動標記為已看過

**提示內容**：
- 郵箱：admin@admin.com
- 密碼：adminadmin
- 建議首次登錄後立即前往「後台管理」→「管理員設定」修改帳號和密碼

#### 4. 後台管理改進

**新增功能**：
- ✅ 管理員設定中顯示默認帳號提示
  - 在「更新當前管理員設定」區塊頂部顯示
  - 包含默認帳號資訊和修改建議
  - 成功修改帳號或密碼後，登入頁面提示自動隱藏

---

## 🐛 Bug 修復

#### 1. 庫存價格數據源問題

**修復內容**：
- ✅ 盤後時段正確使用收盤價而非即時數據
- ✅ API 失敗時自動降級到收盤價，避免價格缺失
- ✅ 緩存機制根據交易時間動態調整，避免不必要的 API 請求

#### 2. 使用指南顯示邏輯

**修復內容**：
- ✅ 修復已看過使用指南後無法再次訪問的問題
- ✅ 優化初次顯示邏輯，確保只在初次登入時自動跳轉

---

## 🔧 技術改進

### 後端改進

1. **價格獲取邏輯優化**
   - 新增 `isTradingHours()` 和 `isTradingDay()` 時間判斷函數
   - 新增 `getCacheDuration()` 動態緩存時間函數
   - 新增 `fetchClosePricesFromOpenAPI()` 收盤價獲取函數
   - 優化 `fetchStockPricesBatch()` 支援智能切換和降級機制

2. **數據結構改進**
   - 返回數據包含 `price_source`（'realtime' 或 'close'）
   - 返回數據包含 `price_updated_at`（時間戳）

3. **設定整合**
   - 讀取 `apiSettings.priceSource` 設定
   - 支援自動、即時、收盤價三種模式

### 前端改進

1. **庫存頁面**
   - 更新 `Holding` 接口，新增價格來源欄位
   - 在市價欄位顯示來源標籤和更新時間
   - 視覺化區分即時價格（綠色）和收盤價（灰色）

2. **使用指南頁面**
   - 優化圖片顯示邏輯
   - 改進初次顯示判斷
   - 添加關閉按鈕和自動跳轉邏輯

3. **登入頁面**
   - 新增默認管理員提示顯示控制
   - 添加關閉按鈕
   - 與後台管理聯動，自動隱藏提示

4. **後台管理頁面**
   - 在管理員設定中添加默認帳號提示
   - 更新帳號/密碼後自動標記提示為已看過

---

## 📋 詳細變更列表

### 新增檔案
- 無

### 修改檔案

#### 後端
- `server/src/routes/holdings.ts`
  - 新增智能價格獲取策略
  - 新增交易時間判斷函數
  - 新增動態緩存機制
  - 新增價格來源資訊返回

#### 前端
- `client/src/pages/Holdings.tsx`
  - 更新 Holding 接口，新增價格來源欄位
  - 在市價欄位顯示來源標籤和更新時間

- `client/src/pages/WelcomeGuide.tsx`
  - 新增讚賞碼 QR Code 圖片顯示
  - 優化初次顯示邏輯
  - 改進圖片尺寸設定

- `client/src/pages/Dashboard.tsx`
  - 優化初次登入跳轉邏輯
  - 移除彈窗代碼

- `client/src/pages/Login.tsx`
  - 新增默認管理員帳號提示顯示控制
  - 添加關閉按鈕
  - 支援 localStorage 記錄

- `client/src/pages/Admin.tsx`
  - 新增默認管理員帳號提示
  - 更新邏輯中自動標記提示為已看過

---

## 🚀 升級說明

### 從 vS0005 升級到 vS0006

1. **數據遷移**：無需手動數據遷移
2. **設定變更**：可在系統設定 → API設定中選擇價格來源模式
3. **緩存清理**：首次運行會自動清除舊緩存

### 注意事項

1. **價格數據**：
   - 盤中時段會使用即時價格（可能會有延遲）
   - 盤後和非交易日使用收盤價
   - 如果即時 API 不穩定，會自動降級到收盤價

2. **使用指南**：
   - 首次登入會自動跳轉到使用指南
   - 已看過的使用者不會再自動顯示，但仍可手動查看

3. **默認管理員提示**：
   - 首次登入會顯示默認帳號提示
   - 建議立即修改帳號和密碼以確保安全
   - 修改後提示會自動隱藏

---

## 📝 已知問題

無

---

## 🔮 未來計劃

- 價格數據來源可擴展性改進
- 更多數據源的支援
- 價格歷史記錄功能

---

## 🙏 致謝

感謝所有使用者的回饋和支持！

---

## 📞 聯絡資訊

如有任何問題或建議，歡迎聯繫：
- Email: icoolhome001@gmail.com

---

**發布日期**: 2026-01-09
**版本號**: vS0006





