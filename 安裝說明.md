# 股票記帳系統 - 安裝與使用說明

## 一、系統需求

- **作業系統**：Windows 10/11
- **Node.js**：v18 或以上版本（若未安裝，`setup-node.bat` 會自動安裝）
- **瀏覽器**：Chrome / Edge / Firefox（建議使用 Chrome）

---

## 二、安裝步驟

### 1. 首次安裝
雙擊執行 `setup-node.bat`，系統會自動：
- 檢查並安裝 Node.js（若未安裝）
- 安裝所有相依套件（npm install）
- 編譯後端 TypeScript 程式碼
- **在桌面建立中文捷徑**

### 2. 桌面捷徑
安裝完成後，桌面會自動建立以下捷徑：

| 捷徑名稱 | 功能 |
|---------|------|
| 📗 **股票記帳系統 - 啟動** | 啟動前後端服務，自動開啟瀏覽器 |
| 📕 **股票記帳系統 - 停止** | 停止所有服務 |
| ⚙️ **股票記帳系統 - 安裝** | 重新安裝/更新系統 |

### 3. 啟動系統
雙擊桌面的「**股票記帳系統 - 啟動**」捷徑，選擇模式：
- **模式 1**：正常模式（顯示終端視窗）
- **模式 2**：後台模式（隱藏視窗）

啟動成功後會自動開啟瀏覽器，預設網址：`http://localhost:3000`

### 4. 停止系統
雙擊桌面的「**股票記帳系統 - 停止**」捷徑，會自動關閉前後端服務。

---

## 三、盈虧計算邏輯說明（對齊點精靈）

### 1. ETF 自動辨識規則

系統會根據**股票代碼**自動判定是否為 ETF，無需手動設定：

| 代碼格式 | 範例 | 類型 |
|---------|------|------|
| `005X` | 0050, 0051, 0056, 0057 | 被動式 ETF |
| `006XXX` | 006203, 006208 | 被動式 ETF |
| `00XXXL` | 00631L, 00670L | 槓桿型 ETF |
| `00XXXR` | 00632R, 00671R | 反向型 ETF |
| `00XXXU` | 00635U, 00677U | 期貨型 ETF |
| `00XXXB` | 00679B, 00710B | 債券型 ETF |
| `00XXXA` | 00980A, 00981A, 00992A | 主動式 ETF |
| `00XXX` | 00878, 00919, 00929 | 一般 ETF |
| **其他** | 2330, 2317, 3008 | **普通股** |

### 2. 費率設定

#### ETF（自動辨識）
| 項目 | 費率 | 說明 |
|-----|------|------|
| 賣出手續費率 | **0.1425%** | 原價（不打折） |
| 賣出交易稅率 | **0.1%** | ETF 標準稅率 |

#### 普通股（非 ETF）
| 項目 | 費率 | 說明 |
|-----|------|------|
| 賣出手續費率 | **0.1425%** | 原價（不打折） |
| 賣出交易稅率 | **0.3%** | 一般股票標準稅率 |

### 3. 盈虧計算公式

```
盈虧 = 市值(整數) - 持有成本(整數) - 賣出費用(整數)
```

#### 各項計算方式：

| 項目 | 計算方式 | 精度處理 |
|-----|---------|---------|
| **股票市值** | 市價 × 股數 | 先無條件捨去到小數2位，再四捨五入成整數 |
| **持有成本** | Σ(成交價 × 成交股數 + 買入手續費) | 四捨五入成整數 |
| **成本均價** | 持有成本 ÷ 股數 | 四捨五入到小數4位 |
| **賣出手續費** | 市值 × 手續費率 | **無條件捨去成整數** |
| **賣出交易稅** | 市值 × 交易稅率 | **無條件捨去成整數** |
| **賣出費用** | 賣出手續費 + 賣出交易稅 | 整數相加 |

### 4. 計算範例

#### 範例一：0050（ETF）
```
現股數量：14,000 股
市價：69.85 元
成本均價：59.8446 元

① 股票市值 = 69.85 × 14,000 = 977,900 元
② 持有成本 = 59.8446 × 14,000 ≈ 837,825 元（四捨五入）
③ 賣出手續費 = floor(977,900 × 0.1425%) = floor(1,393.51) = 1,393 元
④ 賣出交易稅 = floor(977,900 × 0.1%) = floor(977.9) = 977 元 ← ETF 用 0.1%
⑤ 賣出費用 = 1,393 + 977 = 2,370 元
⑥ 盈虧 = 977,900 - 837,825 - 2,370 = 137,705 元 ✅
```

#### 範例二：00992A（主動式 ETF）
```
現股數量：6,000 股
市價：10.59 元
成本均價：10.3758 元

① 股票市值 = 10.59 × 6,000 = 63,540 元
② 持有成本 = 10.3758 × 6,000 ≈ 62,255 元（四捨五入）
③ 賣出手續費 = floor(63,540 × 0.1425%) = floor(90.54) = 90 元
④ 賣出交易稅 = floor(63,540 × 0.1%) = floor(63.54) = 63 元 ← ETF 用 0.1%
⑤ 賣出費用 = 90 + 63 = 153 元
⑥ 盈虧 = 63,540 - 62,255 - 153 = 1,132 元 ✅
```

#### 範例三：2330 台積電（普通股）
```
現股數量：1,000 股
市價：1,000 元
成本均價：900 元

① 股票市值 = 1,000 × 1,000 = 1,000,000 元
② 持有成本 = 900 × 1,000 = 900,000 元
③ 賣出手續費 = floor(1,000,000 × 0.1425%) = floor(1,425) = 1,425 元
④ 賣出交易稅 = floor(1,000,000 × 0.3%) = floor(3,000) = 3,000 元 ← 普通股用 0.3%
⑤ 賣出費用 = 1,425 + 3,000 = 4,425 元
⑥ 盈虧 = 1,000,000 - 900,000 - 4,425 = 95,575 元
```

---

## 四、常見問題

### Q1：啟動時顯示「port 3000/3001 已被佔用」
**解決方式**：先執行 `stop-node.bat` 關閉舊服務，再重新執行 `start-node.bat`

### Q2：盈虧數字與點精靈不一致
**可能原因**：
1. 市價不同步（系統抓取的即時價格與點精靈顯示的可能有時間差）
2. 股票未被正確辨識為 ETF（請確認股票代碼格式）

**解決方式**：在庫存頁面按 F5 強制刷新，或手動輸入盈虧數值

### Q3：如何手動修改盈虧？
在庫存頁面，點擊「盈虧」或「盈虧(%)」欄位即可手動輸入數值，系統會保存您的修改。

---

## 五、技術支援

如有問題，請檢查後端終端視窗的 log 訊息，會顯示每筆股票的詳細計算過程：

```
[國內現股計算結果] 0050 元大台灣50 市值(raw)=977900, 市值(整數)=977900, 
持有成本(raw)=837825, 持有成本(整數)=837825, 
手續費率=0.001425, 交易稅率=0.001, 
手續費(整數捨去)=1393, 交易稅(整數捨去)=977, 
賣出費用(整數)=2370, 盈虧=137705
```

---

**版本**：vS0005  
**最後更新**：2026-01-08
